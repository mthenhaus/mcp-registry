services:
  registry:
    # Built using ko (see Makefile dev-compose target)
    #image: 891377096513.dkr.ecr.us-east-1.amazonaws.com/mcp/registry:latest
    image: ko.local/registry:latest
    container_name: registry
    # See .env.example for more documentation
    environment:
      - MCP_REGISTRY_AWS_REGION=${MCP_REGISTRY_AWS_REGION:-us-east-1}
      - MCP_REGISTRY_DATABASE_TYPE=${MCP_REGISTRY_DATABASE_TYPE:-jsonfile}
      - MCP_REGISTRY_JSON_FILE_PATH=${MCP_REGISTRY_JSON_FILE_PATH:-/data/registry.json}
      - MCP_REGISTRY_ENVIRONMENT=${MCP_REGISTRY_ENVIRONMENT:-test}
      - MCP_REGISTRY_GITHUB_CLIENT_ID=${MCP_REGISTRY_GITHUB_CLIENT_ID:-Iv23licy3GSiM9Km5jtd}
      - MCP_REGISTRY_GITHUB_CLIENT_SECRET=${MCP_REGISTRY_GITHUB_CLIENT_SECRET:-0e8db54879b02c29adef51795586f3c510a9341d}
      - MCP_REGISTRY_JWT_PRIVATE_KEY=${MCP_REGISTRY_JWT_PRIVATE_KEY:-8103179d8ef955f6d3de6d6217224a909ec4060529dfeb1d4ca5a994537658cd}
      - MCP_REGISTRY_ENABLE_ANONYMOUS_AUTH=${MCP_REGISTRY_ENABLE_ANONYMOUS_AUTH:-true}
      - MCP_REGISTRY_SEED_FROM=/data/seed.json
      #- MCP_REGISTRY_SEED_FROM=https://mthenhaus-mcp-registry.s3.us-east-1.amazonaws.com/registry.json
      - MCP_REGISTRY_OIDC_ENABLED=${MCP_REGISTRY_OIDC_ENABLED:-true}
      - MCP_REGISTRY_OIDC_ISSUER=${MCP_REGISTRY_OIDC_ISSUER:-https://accounts.google.com}
      - MCP_REGISTRY_OIDC_CLIENT_ID=${MCP_REGISTRY_OIDC_CLIENT_ID:-32555940559.apps.googleusercontent.com}
      - MCP_REGISTRY_OIDC_EXTRA_CLAIMS=${MCP_REGISTRY_OIDC_EXTRA_CLAIMS:-[{"hd":"modelcontextprotocol.io"}]}
      - MCP_REGISTRY_OIDC_EDIT_PERMISSIONS=${MCP_REGISTRY_OIDC_EDIT_PERMISSIONS:-*}
      - MCP_REGISTRY_OIDC_PUBLISH_PERMISSIONS=${MCP_REGISTRY_OIDC_PUBLISH_PERMISSIONS:-*}
      - MCP_REGISTRY_ENABLE_REGISTRY_VALIDATION=true
    ports:
      - 8080:8080
    volumes:
      - ./data:/data
    restart: "unless-stopped"

  # PostgreSQL service (optional - only needed if using DATABASE_TYPE=postgres)
  # To use PostgreSQL, set MCP_REGISTRY_DATABASE_TYPE=postgres and uncomment the depends_on section above
  # postgres:
  #   image: postgres:16-alpine
  #   container_name: postgres
  #   environment:
  #     POSTGRES_DB: mcp-registry
  #     POSTGRES_USER: mcpregistry
  #     POSTGRES_PASSWORD: mcpregistry
  #     PGDATA: /var/lib/postgresql/data/pgdata
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U mcpregistry -d mcp-registry"]
  #     interval: 1s
  #     retries: 30
  #   ports:
  #     - "5432:5432"
  #   restart: "unless-stopped"
